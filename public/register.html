<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Sistema Delivery</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl my-8">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">üìù</div>
            <h1 class="text-3xl font-bold text-gray-800">Crear Cuenta</h1>
            <p class="text-gray-600 mt-2">√önete a nuestro sistema de delivery</p>
        </div>
        
        <!-- Selector de tipo de cuenta -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button 
                id="clientBtn"
                class="py-3 rounded-lg font-semibold transition bg-blue-600 text-white text-sm"
                onclick="selectRole('client')"
            >
                üë§ Cliente
            </button>
            <button 
                id="driverBtn"
                class="py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm"
                onclick="selectRole('driver')"
            >
                üöó Conductor
            </button>
            <button 
                id="storeBtn"
                class="py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm"
                onclick="selectRole('store_owner')"
            >
                üè™ Tienda
            </button>
        </div>

        <form id="registerForm" class="space-y-4">
            <input type="hidden" id="role" value="client">

            <!-- Campos comunes -->
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre completo *</label>
                    <input 
                        type="text" 
                        id="name"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        required
                        placeholder="Juan P√©rez"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
                    <input 
                        type="tel" 
                        id="phone"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        required
                        placeholder="5512345678"
                    />
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input 
                    type="email" 
                    id="email"
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    required
                    placeholder="tu@email.com"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a *</label>
                <input 
                    type="password" 
                    id="password"
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    required
                    placeholder="M√≠nimo 6 caracteres"
                    minlength="6"
                />
            </div>

            <!-- Campos espec√≠ficos de cliente -->
            <div id="clientFields" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                    <input 
                        type="text" 
                        id="address"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Calle, n√∫mero, colonia"
                    />
                </div>
            </div>

            <!-- Campos espec√≠ficos de conductor -->
            <div id="driverFields" class="hidden space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800">
                        ‚ö†Ô∏è Tu cuenta ser√° revisada antes de ser aprobada. Te notificaremos cuando puedas empezar a trabajar.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Veh√≠culo *</label>
                    <input 
                        type="text" 
                        id="vehicle"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Ej: Moto Honda 2020"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Licencia *</label>
                    <input 
                        type="text" 
                        id="license"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="ABC123456"
                    />
                </div>

                <!-- FOTO DE INE -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üìÑ Foto de INE (Identificaci√≥n) *
                    </label>
                    <input 
                        type="file" 
                        id="inePhoto"
                        accept="image/*"
                        class="hidden"
                        onchange="handleFileSelect(event, 'ine')"
                    />
                    <button 
                        type="button"
                        onclick="document.getElementById('inePhoto').click()"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2"
                    >
                        üì∑ Seleccionar Foto de INE
                    </button>
                    <div id="inePreview" class="mt-3 hidden">
                        <img id="inePreviewImg" class="w-full h-48 object-cover rounded-lg" />
                        <p id="ineStatus" class="text-sm text-gray-600 mt-2 text-center">Preparando subida...</p>
                    </div>
                </div>

                <!-- FOTO DEL VEH√çCULO -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üöó Foto del Veh√≠culo *
                    </label>
                    <input 
                        type="file" 
                        id="vehiclePhoto"
                        accept="image/*"
                        class="hidden"
                        onchange="handleFileSelect(event, 'vehicle')"
                    />
                    <button 
                        type="button"
                        onclick="document.getElementById('vehiclePhoto').click()"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2"
                    >
                        üì∑ Seleccionar Foto del Veh√≠culo
                    </button>
                    <div id="vehiclePreview" class="mt-3 hidden">
                        <img id="vehiclePreviewImg" class="w-full h-48 object-cover rounded-lg" />
                        <p id="vehicleStatus" class="text-sm text-gray-600 mt-2 text-center">Preparando subida...</p>
                    </div>
                </div>
            </div>

            <!-- Campos espec√≠ficos de tienda -->
            <div id="storeFields" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Negocio *</label>
                    <input 
                        type="text" 
                        id="businessName"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Mi Tienda"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n del Negocio *</label>
                    <input 
                        type="text" 
                        id="businessAddress"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Calle, n√∫mero, colonia"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Negocio *</label>
                    <select 
                        id="businessType"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                        <option value="">Selecciona...</option>
                        <option value="restaurant">Restaurante</option>
                        <option value="coffee">Cafeter√≠a</option>
                        <option value="grocery">Abarrotes</option>
                        <option value="pharmacy">Farmacia</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
            </div>

            <button 
                type="submit" 
                id="submitBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition"
            >
                Crear Cuenta
            </button>
        </form>

        <div id="error" class="mt-4 hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
        <div id="success" class="mt-4 hidden p-3 bg-green-100 text-green-700 rounded-lg text-sm"></div>
        
        <div class="mt-6 text-center border-t border-gray-200 pt-6">
            <p class="text-gray-600 text-sm">¬øYa tienes cuenta?</p>
            <a href="/" class="text-blue-600 hover:text-blue-700 font-semibold">
                Iniciar sesi√≥n aqu√≠
            </a>
        </div>
    </div>

    <script>
        let currentRole = 'client';
        let inePhotoFile = null;
        let vehiclePhotoFile = null;

        function selectRole(role) {
            currentRole = role;
            document.getElementById('role').value = role;

            // Reset button styles
            const clientBtn = document.getElementById('clientBtn');
            const driverBtn = document.getElementById('driverBtn');
            const storeBtn = document.getElementById('storeBtn');

            clientBtn.className = 'py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm';
            driverBtn.className = 'py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm';
            storeBtn.className = 'py-3 rounded-lg font-semibold transition bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm';

            // Hide all fields
            const clientFields = document.getElementById('clientFields');
            const driverFields = document.getElementById('driverFields');
            const storeFields = document.getElementById('storeFields');

            clientFields.classList.add('hidden');
            driverFields.classList.add('hidden');
            storeFields.classList.add('hidden');

            if (role === 'client') {
                clientBtn.className = 'py-3 rounded-lg font-semibold transition bg-blue-600 text-white text-sm';
                clientFields.classList.remove('hidden');
                
                document.getElementById('vehicle').removeAttribute('required');
                document.getElementById('license').removeAttribute('required');
                inePhotoFile = null;
                vehiclePhotoFile = null;
            } else if (role === 'driver') {
                driverBtn.className = 'py-3 rounded-lg font-semibold transition bg-blue-600 text-white text-sm';
                driverFields.classList.remove('hidden');
                
                document.getElementById('vehicle').setAttribute('required', 'required');
                document.getElementById('license').setAttribute('required', 'required');
            } else if (role === 'store_owner') {
                storeBtn.className = 'py-3 rounded-lg font-semibold transition bg-blue-600 text-white text-sm';
                storeFields.classList.remove('hidden');
                
                document.getElementById('vehicle').removeAttribute('required');
                document.getElementById('license').removeAttribute('required');
                inePhotoFile = null;
                vehiclePhotoFile = null;
            }
        }

        // Funci√≥n para comprimir imagen
        function compressImage(file, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calcular nuevas dimensiones
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convertir a blob
                        canvas.toBlob(
                            (blob) => {
                                resolve(new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                }));
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert('Solo se permiten im√°genes');
                return;
            }

            try {
                // Comprimir imagen
                const statusEl = type === 'ine' ? document.getElementById('ineStatus') : document.getElementById('vehicleStatus');
                const previewEl = type === 'ine' ? document.getElementById('inePreview') : document.getElementById('vehiclePreview');
                const previewImgEl = type === 'ine' ? document.getElementById('inePreviewImg') : document.getElementById('vehiclePreviewImg');

                statusEl.textContent = 'üîÑ Comprimiendo imagen...';
                statusEl.className = 'text-sm text-blue-600 mt-2 text-center';
                previewEl.classList.remove('hidden');

                const compressedFile = await compressImage(file, 1200, 0.7);

                console.log(`Tama√±o original: ${(file.size / 1024).toFixed(2)}KB`);
                console.log(`Tama√±o comprimido: ${(compressedFile.size / 1024).toFixed(2)}KB`);

                // Guardar archivo comprimido
                if (type === 'ine') {
                    inePhotoFile = compressedFile;
                } else {
                    vehiclePhotoFile = compressedFile;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImgEl.src = e.target.result;
                    statusEl.textContent = `‚úì Imagen lista (${(compressedFile.size / 1024).toFixed(0)}KB)`;
                    statusEl.className = 'text-sm text-green-600 mt-2 text-center font-semibold';
                };
                reader.readAsDataURL(compressedFile);

            } catch (error) {
                console.error('Error procesando imagen:', error);
                alert('Error al procesar la imagen. Por favor intenta con otra.');
            }
        }

        async function uploadImageToBackend(file, fieldName) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('folder', 'drivers');

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error al subir imagen');
            }

            const data = await response.json();
            return data.url;
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            const submitBtn = document.getElementById('submitBtn');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Validar fotos para conductores
            if (currentRole === 'driver') {
                if (!inePhotoFile) {
                    alert('Debes seleccionar la foto de tu INE');
                    return;
                }
                if (!vehiclePhotoFile) {
                    alert('Debes seleccionar la foto de tu veh√≠culo');
                    return;
                }
            }

            // Deshabilitar bot√≥n
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registrando...';

            try {
                const formData = {
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    role: currentRole
                };

                if (currentRole === 'client') {
                    formData.address = document.getElementById('address').value;
                } else if (currentRole === 'driver') {
                    formData.vehicle = document.getElementById('vehicle').value;
                    formData.license = document.getElementById('license').value;

                    // Subir im√°genes al backend
                    submitBtn.textContent = 'Subiendo foto de INE...';
                    document.getElementById('ineStatus').textContent = '‚è≥ Subiendo...';
                    document.getElementById('ineStatus').className = 'text-sm text-blue-600 mt-2 text-center';
                    
                    const ineUrl = await uploadImageToBackend(inePhotoFile, 'inePhoto');
                    formData.inePhoto = ineUrl;
                    
                    document.getElementById('ineStatus').textContent = '‚úì Subida exitosa';
                    document.getElementById('ineStatus').className = 'text-sm text-green-600 mt-2 text-center font-semibold';

                    submitBtn.textContent = 'Subiendo foto de veh√≠culo...';
                    document.getElementById('vehicleStatus').textContent = '‚è≥ Subiendo...';
                    document.getElementById('vehicleStatus').className = 'text-sm text-blue-600 mt-2 text-center';
                    
                    const vehicleUrl = await uploadImageToBackend(vehiclePhotoFile, 'vehiclePhoto');
                    formData.vehiclePhoto = vehicleUrl;
                    
                    document.getElementById('vehicleStatus').textContent = '‚úì Subida exitosa';
                    document.getElementById('vehicleStatus').className = 'text-sm text-green-600 mt-2 text-center font-semibold';
                } else if (currentRole === 'store_owner') {
                    formData.businessName = document.getElementById('businessName').value;
                    formData.businessAddress = document.getElementById('businessAddress').value;
                    formData.businessType = document.getElementById('businessType').value;
                }

                submitBtn.textContent = 'Creando cuenta...';

                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al registrarse');
                }

                // Si es cliente o due√±o de tienda, auto-login y redirigir
                if ((currentRole === 'client' || currentRole === 'store_owner') && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    if (currentRole === 'client') {
                        window.location.href = '/cliente';
                    } else if (currentRole === 'store_owner') {
                        window.location.href = '/tienda';
                    }
                } else {
                    // Si es conductor, mostrar mensaje de √©xito
                    successDiv.innerHTML = `
                        <div class="font-semibold mb-2">‚úÖ Registro exitoso</div>
                        <p class="text-sm">${data.message || 'Tu cuenta ser√° revisada y aprobada pronto.'}</p>
                        <a href="/" class="inline-block mt-3 text-blue-600 hover:text-blue-700 font-semibold">
                            Volver al login
                        </a>
                    `;
                    successDiv.classList.remove('hidden');
                    document.getElementById('registerForm').reset();
                    document.getElementById('inePreview').classList.add('hidden');
                    document.getElementById('vehiclePreview').classList.add('hidden');
                    inePhotoFile = null;
                    vehiclePhotoFile = null;
                }
            } catch (error) {
                console.error('Error en registro:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Crear Cuenta';
            }
        });
    </script>
<script src="/notifications.js"></script>
</body>
</html>
<!-- v3.3 - Con compresi√≥n autom√°tica de im√°genes -->