<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contrase√±a - Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-md"></div>

    <script>
        const API_URL = '/api';
        let currentStep = 1; // 1: Solicitar c√≥digo, 2: Ingresar c√≥digo
        let userIdentifier = '';
        let identifierType = ''; // 'phone' o 'email'

        function render() {
            const app = document.getElementById('app');
            
            if (currentStep === 1) {
                app.innerHTML = renderStep1();
            } else if (currentStep === 2) {
                app.innerHTML = renderStep2();
            } else if (currentStep === 3) {
                app.innerHTML = renderSuccess();
            }
        }

        function renderStep1() {
            return `
                <div class="bg-white rounded-2xl shadow-2xl p-8">
                    <!-- Logo/Header -->
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üîê</div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Recuperar Contrase√±a</h1>
                        <p class="text-gray-600">Ingresa tu tel√©fono o email para recibir un c√≥digo</p>
                    </div>

                    <!-- Formulario -->
                    <form onsubmit="handleRequestCode(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tel√©fono (con c√≥digo de pa√≠s)
                            </label>
                            <input 
                                type="tel" 
                                id="phone"
                                placeholder="521234567890"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                            <p class="text-xs text-gray-500 mt-1">Ejemplo: 521234567890 (M√©xico)</p>
                        </div>

                        <div class="text-center text-gray-500 font-semibold">O</div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Email
                            </label>
                            <input 
                                type="email" 
                                id="email"
                                placeholder="tu@email.com"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                        <div id="info" class="hidden bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm"></div>

                        <button 
                            type="submit"
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 shadow-lg"
                        >
                            üîê Solicitar C√≥digo
                        </button>
                    </form>

                    <!-- Volver al login -->
                    <div class="mt-6 text-center">
                        <a href="/" class="text-blue-600 hover:text-blue-800 font-semibold">
                            ‚Üê Volver al inicio
                        </a>
                    </div>
                </div>
            `;
        }

        function renderStep2() {
            return `
                <div class="bg-white rounded-2xl shadow-2xl p-8">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üì±</div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Ingresar C√≥digo</h1>
                        <p class="text-gray-600">C√≥digo enviado a ${userIdentifier}</p>
                        <p class="text-sm text-gray-500 mt-2">V√°lido por 15 minutos</p>
                    </div>

                    <!-- Informaci√≥n importante -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-800">
                            <strong>üìû Importante:</strong> Si no recibes el c√≥digo, contacta al administrador. 
                            El c√≥digo fue generado y el admin puede proporcion√°rtelo.
                        </p>
                    </div>

                    <!-- Formulario -->
                    <form onsubmit="handleResetPassword(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                C√≥digo de Recuperaci√≥n (6 d√≠gitos)
                            </label>
                            <input 
                                type="text" 
                                id="code"
                                placeholder="123456"
                                maxlength="6"
                                pattern="[0-9]{6}"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-2xl font-bold tracking-widest"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nueva Contrase√±a
                            </label>
                            <input 
                                type="password" 
                                id="newPassword"
                                placeholder="M√≠nimo 6 caracteres"
                                required
                                minlength="6"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Confirmar Nueva Contrase√±a
                            </label>
                            <input 
                                type="password" 
                                id="confirmPassword"
                                placeholder="Repite la contrase√±a"
                                required
                                minlength="6"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

                        <button 
                            type="submit"
                            class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 rounded-lg transition transform hover:scale-105 shadow-lg"
                        >
                            ‚úÖ Cambiar Contrase√±a
                        </button>
                    </form>

                    <!-- Opciones -->
                    <div class="mt-6 space-y-2 text-center">
                        <button 
                            onclick="currentStep = 1; render();"
                            class="text-blue-600 hover:text-blue-800 font-semibold block w-full"
                        >
                            ‚Üê Solicitar nuevo c√≥digo
                        </button>
                        <a href="/" class="text-gray-600 hover:text-gray-800 block">
                            Volver al inicio
                        </a>
                    </div>
                </div>
            `;
        }

        function renderSuccess() {
            return `
                <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
                    <div class="text-6xl mb-6">‚úÖ</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">¬°Contrase√±a Cambiada!</h1>
                    <p class="text-gray-600 mb-8">
                        Tu contrase√±a ha sido actualizada exitosamente.
                        Ya puedes iniciar sesi√≥n con tu nueva contrase√±a.
                    </p>

                    <a 
                        href="/"
                        class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-lg transition transform hover:scale-105 shadow-lg"
                    >
                        üîê Ir a Iniciar Sesi√≥n
                    </a>
                </div>
            `;
        }

        async function handleRequestCode(event) {
            event.preventDefault();
            
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const errorDiv = document.getElementById('error');
            const infoDiv = document.getElementById('info');
            
            errorDiv.classList.add('hidden');
            infoDiv.classList.add('hidden');

            if (!phone && !email) {
                errorDiv.textContent = 'Ingresa tu tel√©fono o email';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, email })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al solicitar c√≥digo');
                }

                userIdentifier = phone || email;
                identifierType = phone ? 'phone' : 'email';
                
                // Si estamos en desarrollo, mostrar el c√≥digo
                if (data.devCode) {
                    infoDiv.innerHTML = `
                        <strong>Modo Desarrollo:</strong><br>
                        Tu c√≥digo es: <span class="text-2xl font-bold">${data.devCode}</span><br>
                        <small class="text-xs">(En producci√≥n, esto no se mostrar√°)</small>
                    `;
                    infoDiv.classList.remove('hidden');
                    
                    // Esperar 2 segundos antes de pasar al siguiente paso
                    setTimeout(() => {
                        currentStep = 2;
                        render();
                    }, 2000);
                } else {
                    currentStep = 2;
                    render();
                }
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            
            const code = document.getElementById('code').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('error');
            
            errorDiv.classList.add('hidden');

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Las contrase√±as no coinciden';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const body = {
                    code,
                    newPassword
                };

                if (identifierType === 'phone') {
                    body.phone = userIdentifier;
                } else {
                    body.email = userIdentifier;
                }

                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cambiar contrase√±a');
                }

                currentStep = 3;
                render();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // Renderizar al cargar
        render();
    </script>
</body>
</html>