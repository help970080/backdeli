<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de la Tienda - Delivery App</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <h1 id="store-header-name">Cargando Tienda...</h1>
            <nav>
                <a href="index.html">Inicio</a>
                <a href="cart.html"><i class="fas fa-shopping-cart"></i> Carrito (<span id="cart-count">0</span>)</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="store-details" class="store-details-section">
            <div class="store-info-header">
                <img id="store-image" src="placeholder.jpg" alt="Imagen de la Tienda" class="store-main-image">
                <div class="info-text">
                    <h2 id="store-name"></h2>
                    <p id="store-description"></p>
                    <p class="store-status" id="store-status">Estado: <span class="status-indicator"></span></p>
                    <div class="store-meta">
                        <span><i class="fas fa-motorcycle"></i> Env√≠o: <span id="store-fee"></span></span>
                        <span><i class="fas fa-clock"></i> Tiempo: <span id="store-time"></span></span>
                        <span><i class="fas fa-money-bill"></i> M√≠nimo: <span id="store-min-order"></span></span>
                    </div>
                </div>
            </div>
            <p id="store-address" class="address-text"><i class="fas fa-map-marker-alt"></i></p>
            <hr>
        </section>

        <section id="products-section">
            <h3>Nuestros Productos</h3>
            <div id="product-list" class="product-grid">
                </div>
            <p id="no-products" class="hidden">No hay productos disponibles en esta tienda.</p>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Delivery App. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('id');

            if (!storeId) {
                document.getElementById('store-header-name').textContent = 'Error: Tienda no especificada';
                return;
            }

            fetchStoreDetails(storeId);
            updateCartCount();
        });

        async function fetchStoreDetails(storeId) {
            try {
                // 1. Obtener detalles de la tienda
                const response = await fetch(`/api/stores/${storeId}`);
                if (!response.ok) throw new Error('Tienda no encontrada');
                const { store, products } = await response.json();

                // 2. Renderizar detalles de la tienda
                renderStoreInfo(store);

                // 3. Renderizar productos
                renderProducts(products);

            } catch (error) {
                console.error('Error al obtener detalles:', error);
                document.getElementById('store-header-name').textContent = 'Tienda no disponible';
                document.getElementById('store-details').innerHTML = `<p class="error-message">${error.message}. Por favor, regresa a la <a href="index.html">p√°gina principal</a>.</p>`;
                document.getElementById('products-section').classList.add('hidden');
            }
        }

        function renderStoreInfo(store) {
            document.getElementById('store-header-name').textContent = store.name;
            document.getElementById('store-name').textContent = store.name;
            document.getElementById('store-description').textContent = store.description;

            // üõë CORRECCI√ìN CLOUDINARY CR√çTICA üõë
            // Usamos directamente la URL que viene del backend, sin prefijos /uploads/
            const storeImage = document.getElementById('store-image');
            storeImage.src = store.image || 'placeholder.jpg';
            storeImage.alt = `Imagen de ${store.name}`;
            // üõë FIN DE CORRECCI√ìN üõë
            
            document.getElementById('store-fee').textContent = `$${store.deliveryFee.toFixed(2)}`;
            document.getElementById('store-time').textContent = `${store.deliveryTime} min`;
            document.getElementById('store-min-order').textContent = `$${store.minOrder.toFixed(2)}`;
            document.getElementById('store-address').textContent = store.location.address;

            const statusIndicator = document.querySelector('#store-status .status-indicator');
            if (store.isOpen) {
                statusIndicator.textContent = 'Abierta';
                statusIndicator.style.color = 'green';
            } else {
                statusIndicator.textContent = 'Cerrada';
                statusIndicator.style.color = 'red';
            }
        }

        function renderProducts(products) {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            
            if (products.length === 0) {
                document.getElementById('no-products').classList.remove('hidden');
                return;
            }
            document.getElementById('no-products').classList.add('hidden');

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // üõë CORRECCI√ìN CLOUDINARY CR√çTICA üõë
                // Usamos directamente la URL que viene del backend, sin prefijos /uploads/
                const imageUrl = product.image || 'placeholder.jpg';
                // üõë FIN DE CORRECCI√ìN üõë

                productCard.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}">
                    <h4>${product.name}</h4>
                    <p class="product-description">${product.description}</p>
                    <p class="product-price">$${product.price.toFixed(2)}</p>
                    <button 
                        class="add-to-cart-btn ${product.available ? '' : 'disabled'}" 
                        data-product-id="${product.id}"
                        data-store-id="${product.storeId}"
                        ${product.available ? '' : 'disabled'}
                    >
                        ${product.available ? 'A√±adir al Carrito' : 'No Disponible'}
                    </button>
                `;
                productList.appendChild(productCard);

                // Agregar listener al bot√≥n si est√° disponible
                if (product.available) {
                    productCard.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                        addToCart(product);
                    });
                }
            });
        }

        function getCart() {
            const cart = localStorage.getItem('cart');
            return cart ? JSON.parse(cart) : { items: [], storeId: null, storeName: null };
        }

        function saveCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }

        function updateCartCount() {
            const cart = getCart();
            const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }

        function addToCart(product) {
            let cart = getCart();

            if (cart.storeId && cart.storeId !== product.storeId) {
                if (!confirm(`Ya tienes productos de otra tienda (${cart.storeName}) en tu carrito. ¬øQuieres vaciar el carrito y a√±adir este producto de ${document.getElementById('store-name').textContent}?`)) {
                    return;
                }
                cart = { items: [], storeId: null, storeName: null }; // Vaciar carrito
            }

            // Si el carrito est√° vac√≠o, establecer la tienda
            if (!cart.storeId) {
                cart.storeId = product.storeId;
                cart.storeName = document.getElementById('store-name').textContent;
            }

            const existingItem = cart.items.find(item => item.productId === product.id);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.items.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image, // Guardamos la URL de Cloudinary
                    quantity: 1
                });
            }

            saveCart(cart);
            alert(`"${product.name}" a√±adido al carrito!`);
        }

    </script>
</body>
</html>